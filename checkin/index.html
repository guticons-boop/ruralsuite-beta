<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Check-in Pro | RuralGesto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,900&display=swap" rel="stylesheet">
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f9f9f9; }
        .italic-black { font-style: italic; font-weight: 900; letter-spacing: -1px; }
        .form-input { width: 100%; padding: 16px; border-radius: 18px; border: 1.5px solid #eee; margin-bottom: 12px; font-weight: 600; outline: none; background: #fff; }
        #video { width: 100%; border-radius: 24px; display: none; background: #000; }
        #canvas { display: none; }
        .loading-spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 max-w-lg mx-auto">

    <header class="mb-10 flex justify-between items-center">
        <button onclick="location.href='/hub/'" class="text-[10px] font-black text-gray-400 italic uppercase border border-gray-200 px-4 py-2 rounded-full">‚Üê Volver</button>
        <h1 class="italic-black text-2xl uppercase text-blue-600">Check-in Pro</h1>
    </header>

    <div id="scanner-container" class="mb-8">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <button id="btn-scan" onclick="startCamera()" class="w-full bg-black text-white p-6 rounded-[32px] flex items-center justify-between shadow-xl mb-4">
            <div class="text-left">
                <p class="italic-black text-lg uppercase leading-none">Escanear DNI</p>
                <p class="text-[9px] font-bold opacity-40 uppercase mt-1">C√°mara Inteligente</p>
            </div>
            <span class="text-3xl">üì∏</span>
        </button>

        <div id="loading" class="flex flex-col items-center mb-4 hidden">
            <div class="loading-spinner mb-2"></div>
            <p class="text-[10px] font-black uppercase text-blue-600 italic">Analizando documento...</p>
        </div>

        <button id="btn-capture" onclick="captureAndProcess()" class="hidden w-full bg-blue-600 text-white p-4 rounded-2xl font-black italic uppercase mb-4">Capturar Foto</button>
    </div>

    <div class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-50">
        <div class="space-y-1">
            <label class="text-[10px] font-black uppercase ml-3 text-gray-400">Nombre Completo</label>
            <input type="text" id="fname" placeholder="Pendiente de esc√°ner..." class="form-input">
        </div>

        <div class="space-y-1">
            <label class="text-[10px] font-black uppercase ml-3 text-gray-400">DNI / Pasaporte</label>
            <input type="text" id="doc_num" placeholder="N√∫mero detectado" class="form-input">
        </div>

        <button onclick="save()" class="w-full bg-blue-600 text-white p-6 rounded-2xl font-black italic uppercase mt-6">Finalizar Registro</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const btnScan = document.getElementById('btn-scan');
        const btnCapture = document.getElementById('btn-capture');
        const loading = document.getElementById('loading');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.style.display = 'block';
                btnScan.classList.add('hidden');
                btnCapture.classList.remove('hidden');
            } catch (err) {
                alert("Error al acceder a la c√°mara. Aseg√∫rate de dar permisos.");
            }
        }

        function captureAndProcess() {
            loading.classList.remove('hidden');
            btnCapture.classList.add('hidden');
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Procesar con Tesseract OCR
            Tesseract.recognize(canvas.toDataURL('image/png'), 'spa')
                .then(({ data: { text } }) => {
                    console.log(text);
                    extractData(text);
                })
                .finally(() => {
                    loading.classList.add('hidden');
                    video.style.display = 'none';
                    btnScan.classList.remove('hidden');
                    // Detener c√°mara
                    video.srcObject.getTracks().forEach(track => track.stop());
                });
        }

        function extractData(text) {
            // L√≥gica simple para buscar patrones (esto es lo que hace el "Pro")
            const dniMatch = text.match(/\d{8}[A-Z]/);
            if(dniMatch) document.getElementById('doc_num').value = dniMatch[0];
            
            // Intenta pillar l√≠neas en may√∫sculas para el nombre
            const lines = text.split('\n').filter(l => l.length > 5);
            if(lines.length > 0) document.getElementById('fname').value = lines[0].trim();
            
            alert("Escaneo finalizado. Revisa los datos.");
        }

        function save() {
            alert("Guardado en RuralGesto");
            location.href='/hub/';
        }
    </script>
</body>
</html>
