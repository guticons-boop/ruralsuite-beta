<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Entrada | RuralGesto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fdfdfb; color: #1e293b; }
        .serif { font-family: 'DM+Serif+Display', serif; }
        .tab-btn.active { background-color: #065f46; color: white; border-radius: 20px; }
        #video-feed { width: 100%; border-radius: 30px; background: black; }
        #camera-canvas { display: none; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #065f46; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8 pb-32">

    <div class="max-w-xl mx-auto">
        <header class="flex items-center gap-4 mb-8">
            <button onclick="location.href='../hub/index.html'" class="p-4 bg-white rounded-3xl shadow-sm border border-gray-100">
                <i data-lucide="arrow-left"></i>
            </button>
            <div>
                <h2 class="serif text-2xl italic text-emerald-900 font-bold">Gestión de Entrada</h2>
                <p class="text-[9px] font-black uppercase tracking-widest text-emerald-600">Check-in Pro RuralGesto</p>
            </div>
        </header>

        <div class="grid grid-cols-3 gap-1 bg-white border border-slate-100 p-1 rounded-[25px] mb-8 shadow-sm">
            <button onclick="switchTab('escaneo')" id="tab-escaneo" class="tab-btn active py-3 text-[8px] font-black uppercase tracking-tighter transition-all">Escáner DNI</button>
            <button onclick="switchTab('enviar')" id="tab-enviar" class="tab-btn py-3 text-[8px] font-black uppercase tracking-tighter text-slate-400 transition-all">Enviar Link</button>
            <button onclick="switchTab('importar')" id="tab-importar" class="tab-btn py-3 text-[8px] font-black uppercase tracking-tighter text-slate-400 transition-all">Importar</button>
        </div>

        <div id="view-escaneo" class="space-y-6">
            <div class="relative bg-black rounded-[40px] overflow-hidden shadow-xl aspect-video">
                <video id="video-feed" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div id="loading-overlay" class="absolute inset-0 bg-black/80 hidden flex-col items-center justify-center text-white">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-[9px] font-black uppercase italic">Analizando DNI...</p>
                </div>
            </div>
            <button onclick="capturePhoto()" class="w-full py-6 bg-emerald-900 text-white rounded-[30px] font-black text-[10px] uppercase tracking-widest shadow-xl flex items-center justify-center gap-3">
                <i data-lucide="camera"></i> Escanear DNI en Vivo
            </button>
            
            <div id="ocr-results" class="bg-white p-6 rounded-[35px] border border-slate-100 space-y-3">
                <input type="text" id="res-name" placeholder="Nombre extraído..." class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none outline-none">
                <input type="text" id="res-dni" placeholder="DNI extraído..." class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none outline-none">
                <button onclick="alert('Guardado en el registro')" class="w-full py-4 bg-emerald-50 text-emerald-700 rounded-2xl font-black text-[9px] uppercase italic">Confirmar e Insertar</button>
            </div>
        </div>

        <div id="view-enviar" class="hidden space-y-6">
            <div class="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm">
                <h3 class="serif text-xl italic mb-6">WhatsApp Check-in Online</h3>
                <div class="space-y-4">
                    <select id="house-select" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none">
                        <option>La Tirolina</option>
                        <option>La Ermita</option>
                        <option>Los Almendros</option>
                    </select>
                    <input type="tel" id="guest-phone" placeholder="Móvil del cliente (ej. 600000000)" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold border-none">
                    <button onclick="sendWhatsApp()" class="w-full py-5 bg-emerald-600 text-white rounded-3xl font-black text-[9px] uppercase tracking-widest flex items-center justify-center gap-2">
                        <i data-lucide="send"></i> Enviar por WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <div id="view-importar" class="hidden space-y-6">
            <div class="bg-white p-10 rounded-[40px] border-2 border-dashed border-slate-200 text-center">
                <input type="file" id="file-input" class="hidden" onchange="alert('Archivo detectado')">
                <div onclick="document.getElementById('file-input').click()" class="cursor-pointer">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="file-text"></i>
                    </div>
                    <p class="text-xs font-black uppercase text-slate-700">Importar Check-in Scan</p>
                    <p class="text-[9px] text-slate-400 mt-2 italic">Sube el listado de viajeros para el Marketing</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('camera-canvas');
        const loading = document.getElementById('loading-overlay');

        function switchTab(tab) {
            ['escaneo', 'enviar', 'importar'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('active', 'text-white');
                document.getElementById('tab-' + t).classList.add('text-slate-400');
            });
            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active', 'text-white');
            if(tab === 'escaneo') startCamera();
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { console.error("No se pudo acceder a la cámara"); }
        }

        async function capturePhoto() {
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const { data: { text } } = await Tesseract.recognize(canvas, 'spa');
            
            const dniMatch = text.match(/\d{8}[A-Z]/);
            if(dniMatch) document.getElementById('res-dni').value = dniMatch[0];
            
            const lines = text.split('\n').filter(l => l.length > 5);
            if(lines.length > 0) document.getElementById('res-name').value = lines[0].replace(/[^a-zA-Z ]/g, "");
            
            loading.classList.remove('flex');
            loading.classList.add('hidden');
        }

        function sendWhatsApp() {
            const phone = document.getElementById('guest-phone').value;
            const house = document.getElementById('house-select').value;
            const msg = encodeURIComponent(`Hola, soy Toni de El Rinconcito. Puedes hacer el check-in online aquí: https://ruralgesto.com/checkin/${house}`);
            window.open(`https://wa.me/34${phone}?text=${msg}`);
        }

        startCamera();
    </script>
</body>
</html>
